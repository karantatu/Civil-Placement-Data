<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Civil Placement Data</title>

<style>
:root{
  --brand:#0f4c81;
  --muted:#6b7280;
  --bg:#f6f8fb;
  --card:#ffffff;
  --accent:#2563eb;
  --radius:10px;
  --glass: rgba(255,255,255,0.6);
}

/* reset & base */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans";
  background:linear-gradient(180deg,#f6f8fb 0%, #eef4fb 100%);
  color:#061220;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* Page header */
header{
  background:linear-gradient(90deg,var(--brand),#143f6b);
  color:white;
  padding:14px 16px;
  position:sticky;
  top:0;
  z-index:1000;
  box-shadow:0 4px 18px rgba(8,16,30,0.18);
}
.header-inner{
  max-width:1100px;
  margin:auto;
  display:flex;
  gap:12px;
  align-items:center;
  justify-content:space-between;
}
.header-left{display:flex; gap:12px; align-items:center}
header h1{ margin:0; font-size:18px; letter-spacing:0.2px; font-weight:700 }
header p{ margin:0; font-size:13px; opacity:0.95 }

/* main container */
main{
  max-width:1100px;
  margin:18px auto;
  padding:0 16px 60px;
}

/* top controls */
.controls{
  display:flex;
  gap:12px;
  align-items:center;
  justify-content:space-between;
  margin-bottom:14px;
  flex-wrap:wrap;
}
.controls-left{display:flex; gap:12px; align-items:center}
#searchBox{
  width:320px;
  max-width:60vw;
  padding:10px 12px;
  border-radius:9px;
  border:1px solid #d7e3f5;
  background:white;
  font-size:14px;
  box-shadow:0 2px 8px rgba(12,34,63,0.04);
}
#searchBox:focus{outline:none; box-shadow:0 0 0 4px rgba(37,99,235,0.09); border-color:var(--accent)}

/* summary card */
.summary-wrap{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:12px;
  margin-bottom:16px;
}
@media (max-width:880px){
  .summary-wrap{grid-template-columns:1fr}
}
.summary-card{
  background:var(--card);
  border-radius:12px;
  padding:14px;
  box-shadow:0 6px 20px rgba(12,34,63,0.06);
}
.summary-title{ color:var(--brand); font-weight:700; margin:0 0 8px; font-size:15px }
.summary-grid{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.stat{
  flex:1 1 45%;
  background:linear-gradient(180deg,#fff 0%, #fbfdff 100%);
  border-radius:10px;
  padding:10px;
  box-shadow:inset 0 -1px 0 rgba(10,20,40,0.02);
}
.stat label{display:block; color:var(--muted); font-size:12px; margin-bottom:6px}
.stat strong{display:block; font-size:18px; color:#0f4c81}

/* batch mini summary */
.batch-summary{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:8px;
}
.batch-card{
  background:#f8fbff;
  border-radius:10px;
  padding:8px 10px;
  min-width:140px;
  box-shadow:0 2px 8px rgba(10,24,45,0.04);
}
.batch-card small{display:block; color:var(--muted); font-size:12px}
.batch-card b{display:block; color:#0b1220; font-size:15px; margin-top:6px}

/* batch/division section */
.batch{
  margin-bottom:18px;
}
.batch-header{
  font-size:17px;
  color:var(--brand);
  font-weight:700;
  margin:8px 0 10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.batch-actions{display:flex; gap:8px; align-items:center}
.btn{
  display:inline-block;
  background:var(--accent);
  color:white;
  padding:6px 10px;
  border-radius:8px;
  font-size:13px;
  text-decoration:none;
  cursor:pointer;
  border:none;
}
.ghost{
  background:transparent;
  color:var(--brand);
  border:1px solid rgba(15,76,129,0.08);
}

/* division card (table container) */
.division-card{
  background:var(--card);
  border-radius:12px;
  padding:12px;
  margin-bottom:12px;
  box-shadow:0 8px 30px rgba(10,24,45,0.04);
}
.division-title{
  font-size:15px;
  font-weight:700;
  margin-bottom:8px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

/* scrollable table area with sticky header */
.table-container{
  max-height:360px;
  overflow:auto;
  border-radius:8px;
  border:1px solid #eef6ff;
}
table{
  width:100%;
  border-collapse:collapse;
  min-width:700px;
}
thead th{
  background:linear-gradient(180deg,#eef8ff 0%, #e8f3ff 100%);
  position:sticky;
  top:0;
  z-index:6;
  padding:10px 12px;
  text-align:left;
  font-weight:700;
  cursor:pointer;
  border-bottom:1px solid #e6f0fb;
}
tbody td{
  padding:10px 12px;
  border-bottom:1px solid #f1f6fb;
  font-size:14px;
  vertical-align:middle;
}
.empty{
  color:var(--muted);
  text-align:center;
  padding:18px;
  font-style:italic;
}

/* small helpers */
.count-pill{
  font-size:12px;
  color:var(--muted);
  background:transparent;
  border-radius:8px;
  padding:4px 8px;
}
.link-btn{
  display:inline-block;
  padding:6px 8px;
  border-radius:8px;
  font-size:12px;
  text-decoration:none;
  border:none;
  background:#0f4c81;
  color:white;
}

/* responsive tweaks */
@media (max-width:880px){
  .controls{flex-direction:column; align-items:flex-start}
  #searchBox{width:100%}
  table{ min-width:640px; font-size:13px }
}
</style>
</head>
<body>
<header>
  <div class="header-inner">
    <div class="header-left">
      <div>
        <h1>Civil Placement Data</h1>
        <p style="margin-top:4px; font-size:12px; opacity:0.95">Batch-wise Placement & Higher Study records</p>
      </div>
    </div>
    <div style="font-size:13px; opacity:0.9">Updated: <span id="updatedAt">—</span></div>
  </div>
</header>

<main id="app">
  <div class="controls">
    <div class="controls-left">
      <input id="searchBox" type="search" placeholder="Search by name, roll, company, college, outcome..." />
      <button id="resetBtn" class="btn ghost" title="Clear search">Reset</button>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <div class="count-pill" id="visibleCount">Showing: —</div>
      <button id="refreshBtn" class="btn">Refresh</button>
    </div>
  </div>

  <!-- Summary area (populated by JS) -->
  <div id="summaryBox" class="summary-wrap" aria-hidden="false">
    <!-- JS will insert overall + batch summary cards here -->
  </div>

  <!-- Data area (populated by JS) -->
  <div id="dataArea">
    <p style="color:var(--muted); text-align:center;">Loading data…</p>
  </div>
</main>

<script>
/* ====== CONFIG ====== */
const API_URL = "https://script.google.com/macros/s/AKfycbzZktXlHMkMdYk20t7InRdMe4TgdALW7jeulQEV53Wg1rSL8ruteB8VyE1FqvlZ3vay_Q/exec";
const BATCHES = ["22-23","23-24","24-25"];
const DIVISIONS = ["A","B"];

/* ====== HELPERS ====== */
function escapeHtml(s){ return String(s||"").replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function isUrl(s){ return typeof s === "string" && /^https?:\/\//i.test(s.trim()); }
function nowISO(){ return new Date().toLocaleString(); }

/* ====== SUMMARY COMPUTATION ====== */
function computeSummary(data){
  const summary = {
    overall: { total:0, placed:0, higher:0, proof:0 },
    batches: {}
  };

  BATCHES.forEach(batch=>{
    summary.batches[batch] = { total:0, placed:0, higher:0, proof:0, divisions:{} };
    DIVISIONS.forEach(div=> summary.batches[batch].divisions[div] = { total:0, placed:0, higher:0, proof:0 });
  });

  BATCHES.forEach(batch=>{
    if(!data[batch]) return;
    DIVISIONS.forEach(div=>{
      const rows = Array.isArray(data[batch][div]) ? data[batch][div] : [];
      rows.forEach(r=>{
        summary.overall.total++;
        summary.batches[batch].total++;
        summary.batches[batch].divisions[div].total++;

        if(r.company && String(r.company).trim() !== ""){
          summary.overall.placed++;
          summary.batches[batch].placed++;
          summary.batches[batch].divisions[div].placed++;
        }
        if(r.college && String(r.college).trim() !== ""){
          summary.overall.higher++;
          summary.batches[batch].higher++;
          summary.batches[batch].divisions[div].higher++;
        }
        if((r.companyLink && isUrl(r.companyLink)) || (r.collegeLink && isUrl(r.collegeLink))){
          summary.overall.proof++;
          summary.batches[batch].proof++;
          summary.batches[batch].divisions[div].proof++;
        }
      });
    });
  });

  return summary;
}

/* ====== BUILD SUMMARY HTML ====== */
function renderSummary(summary){
  const overall = summary.overall;
  // overall card + batch card
  let html = `
    <div class="summary-card">
      <div class="summary-title">Overall Summary</div>
      <div class="summary-grid">
        <div class="stat"><label>Total Records</label><strong id="sumTotal">${overall.total}</strong></div>
        <div class="stat"><label>Placed Students</label><strong id="sumPlaced">${overall.placed}</strong></div>
        <div class="stat"><label>Higher Studies</label><strong id="sumHigher">${overall.higher}</strong></div>
        <div class="stat"><label>Proof Links</label><strong id="sumProof">${overall.proof}</strong></div>
      </div>
      <div style="margin-top:10px; color:var(--muted); font-size:13px;">Tip: Search will update the numbers below to match visible rows.</div>
    </div>
  `;

  // batch summary card
  let batchHtml = `<div class="summary-card"><div class="summary-title">Batch Summary</div><div class="batch-summary">`;
  for(const batch of BATCHES){
    const b = summary.batches[batch];
    batchHtml += `
      <div class="batch-card" data-batch="${batch}">
        <small>Batch ${escapeHtml(batch)}</small>
        <b>${b.total} records</b>
        <small style="margin-top:6px; display:block; color:var(--muted);">Placed: ${b.placed} · Higher: ${b.higher} · Proof: ${b.proof}</small>
      </div>
    `;
  }
  batchHtml += `</div></div>`;

  document.getElementById("summaryBox").innerHTML = html + batchHtml;
}

/* ====== TABLE BUILDER ====== */
function buildTableRows(rows){
  // returns tbody HTML string with data attributes for quick counting
  if(!rows || rows.length === 0){
    return `<tr class="empty"><td colspan="5" class="empty">No records</td></tr>`;
  }
  return rows.map(r=>{
    const company = r.company ? escapeHtml(r.company) : "";
    const college = r.college ? escapeHtml(r.college) : "";
    const outcome = (company || college) ? `${company}${company && college ? " / " : ""}${college}` : "";
    const hasCompany = r.company && String(r.company).trim() !== "";
    const hasCollege = r.college && String(r.college).trim() !== "";
    const hasProof = (r.companyLink && isUrl(r.companyLink)) || (r.collegeLink && isUrl(r.collegeLink));
    const proofButtons = `
      ${isUrl(r.companyLink) ? `<a class="link-btn" href="${r.companyLink}" target="_blank" rel="noopener">Offer</a>` : ""}
      ${isUrl(r.collegeLink) ? `<a class="link-btn" href="${r.collegeLink}" target="_blank" rel="noopener">College</a>` : ""}
    `;

    // store flags using data attributes so filtering summary can use them later
    return `
      <tr data-placed="${hasCompany ? 1:0}" data-higher="${hasCollege?1:0}" data-proof="${hasProof?1:0}">
        <td>${escapeHtml(r.sr||"")}</td>
        <td>${escapeHtml(r.roll||"")}</td>
        <td>${escapeHtml(r.name||"")}</td>
        <td>${outcome}</td>
        <td>${proofButtons}</td>
      </tr>
    `;
  }).join("");
}

function buildDivisionCard(batch, division, rowsHtml){
  return `
    <div class="division-card" data-batch="${batch}" data-division="${division}">
      <div class="division-title">
        <div>Division ${division}</div>
        <div style="display:flex; gap:8px; align-items:center">
          <span class="count-pill">Records: <b class="div-count">${rowsHtml.includes('<tr') ? (rowsHtml.match(/<tr/g)||[]).length : 0}</b></span>
        </div>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th data-key="sr">Sr</th>
              <th data-key="roll">Roll</th>
              <th data-key="name">Name</th>
              <th data-key="outcome">Company / College</th>
              <th data-key="proof">Proof</th>
            </tr>
          </thead>
          <tbody>
            ${rowsHtml}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

/* ====== RENDER FULL PAGE ====== */
function renderAll(data){
  // summary
  const summary = computeSummary(data);
  renderSummary(summary);
  document.getElementById('updatedAt').innerText = nowISO();

  // data area
  const container = document.getElementById("dataArea");
  container.innerHTML = ""; // reset

  BATCHES.forEach(batch=>{
    if(!data[batch]) return;
    // create batch section
    const batchSection = document.createElement("div");
    batchSection.className = "batch";
    batchSection.innerHTML = `
      <div class="batch-header">
        <div>Batch ${escapeHtml(batch)}</div>
        <div class="batch-actions">
          <div class="count-pill">Total: <b>${summary.batches[batch].total}</b></div>
          <button class="btn ghost toggle-batch" data-batch="${batch}">Collapse</button>
        </div>
      </div>
    `;

    // add divisions
    DIVISIONS.forEach(div=>{
      const rows = Array.isArray(data[batch][div]) ? data[batch][div] : [];
      const tbody = buildTableRows(rows);
      const cardHtml = buildDivisionCard(batch, div, tbody);
      const wrapper = document.createElement("div");
      wrapper.innerHTML = cardHtml;
      batchSection.appendChild(wrapper.firstElementChild);
    });

    container.appendChild(batchSection);
  });

  // attach behaviors (sorting & toggle)
  attachSortToAllTables();
  attachBatchToggle();
  updateVisibleCount();
}

/* ====== SORTING ====== */
function attachSortToAllTables(){
  document.querySelectorAll("table").forEach(table=>{
    const headers = table.querySelectorAll("th[data-key]");
    headers.forEach((header, idx)=>{
      // add a little caret indicator (via title) for UX
      header.style.userSelect = "none";
      header.title = "Click to sort";
      let asc = true;
      header.addEventListener("click", ()=>{
        const tbody = table.querySelector("tbody");
        const rows = Array.from(tbody.querySelectorAll("tr")).filter(r=>!r.classList.contains("empty"));
        rows.sort((a,b)=>{
          const aText = a.children[idx].innerText.trim().toLowerCase();
          const bText = b.children[idx].innerText.trim().toLowerCase();
          const aNum = parseFloat(aText.replace(/[^\d.-]/g,''));
          const bNum = parseFloat(bText.replace(/[^\d.-]/g,''));
          if(!isNaN(aNum) && !isNaN(bNum)){
            return asc ? aNum - bNum : bNum - aNum;
          }
          return asc ? aText.localeCompare(bText) : bText.localeCompare(aText);
        });
        rows.forEach(r=>tbody.appendChild(r));
        asc = !asc;
      });
    });
  });
}

/* ====== BATCH COLLAPSE ====== */
function attachBatchToggle(){
  document.querySelectorAll(".toggle-batch").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const batch = btn.dataset.batch;
      const section = btn.closest(".batch");
      const isCollapsed = btn.dataset.collapsed === "1";
      section.querySelectorAll(".division-card").forEach(card=>{
        card.style.display = isCollapsed ? "" : "none";
      });
      btn.textContent = isCollapsed ? "Collapse" : "Expand";
      btn.dataset.collapsed = isCollapsed ? "0" : "1";
    });
  });
}

/* ====== SEARCH ====== */
function applySearch(q){
  q = String(q||"").trim().toLowerCase();
  const rows = document.querySelectorAll("tbody tr");
  let visible = 0, placed = 0, higher = 0, proof = 0;

  rows.forEach(row=>{
    if(row.classList.contains("empty")) return;
    const text = row.innerText.toLowerCase();
    const visibleNow = q === "" ? true : text.includes(q);
    row.style.display = visibleNow ? "" : "none";

    if(visibleNow){
      visible++;
      if(row.dataset.placed === "1") placed++;
      if(row.dataset.higher === "1") higher++;
      if(row.dataset.proof === "1") proof++;
    }
  });

  // update visible count & dynamic summary numbers
  document.getElementById("visibleCount").innerText = `Showing: ${visible} rows`;
  // update overall summary numbers to reflect visible rows
  const sumTotal = document.getElementById("sumTotal");
  const sumPlaced = document.getElementById("sumPlaced");
  const sumHigher = document.getElementById("sumHigher");
  const sumProof = document.getElementById("sumProof");

  if(sumTotal && sumPlaced && sumHigher && sumProof){
    sumTotal.innerText = visible;
    sumPlaced.innerText = placed;
    sumHigher.innerText = higher;
    sumProof.innerText = proof;
  }

  // update per-division counts (Records:) shown inside each division card
  document.querySelectorAll(".division-card").forEach(card=>{
    const visibleRows = Array.from(card.querySelectorAll("tbody tr")).filter(r => r.style.display !== "none" && !r.classList.contains("empty"));
    const pill = card.querySelector(".div-count");
    if(pill) pill.innerText = visibleRows.length;
  });
}

/* keep visible count in header (initial and after refresh) */
function updateVisibleCount(){
  // count total rows initially
  const rows = document.querySelectorAll("tbody tr");
  const total = Array.from(rows).filter(r=>!r.classList.contains("empty")).length;
  document.getElementById("visibleCount").innerText = `Showing: ${total} rows`;
  // reset summary numbers to overall counts (first render)
  // we can re-run applySearch with empty string to refresh the dynamic summary
  applySearch(document.getElementById("searchBox").value || "");
}

/* ====== DATA LOADING ====== */
function loadData(){
  const dataArea = document.getElementById("dataArea");
  dataArea.innerHTML = `<p style="color:var(--muted); text-align:center;">Loading data…</p>`;
  fetch(API_URL)
    .then(res => {
      if(!res.ok) throw new Error("Fetch error");
      return res.json();
    })
    .then(data => {
      // Expecting structure: { "22-23": { "A": [...], "B": [...] }, ... }
      renderAll(data);
      // ensure search input triggers filtering
      document.getElementById("searchBox").addEventListener("input", e => {
        applySearch(e.target.value);
      });
      // reset button
      document.getElementById("resetBtn").addEventListener("click", ()=>{
        document.getElementById("searchBox").value = "";
        applySearch("");
      });
      // refresh button
      document.getElementById("refreshBtn").addEventListener("click", ()=>{
        loadData();
      });
    })
    .catch(err => {
      console.error(err);
      dataArea.innerHTML = `<p style="color:red; text-align:center;">Failed to load data</p>`;
      document.getElementById('updatedAt').innerText = '—';
    });
}

/* initial load */
loadData();
</script>

</body>
</html>
